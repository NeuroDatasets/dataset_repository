<!DOCTYPE html>
<html>
<head>
  <title>Dataset Search</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <style>
    .description {
      font-size: smaller;
    }
    .metadata {
      font-style: italic;
      color: gray;
    }
    .no-results {
      color: red;
    }
  </style>
</head>
<body>
  <input type="text" id="search-input" oninput="search()">
  <div>
    <label><input type="checkbox" id="species-mouse" onchange="search()"> Mouse</label>
    <label><input type="checkbox" id="type-ephys" onchange="search()"> Electrophysiology</label>
    <!-- Add more checkbox filters for other criteria -->
  </div>
  <div id="results"></div>

  <script>
    var idx;
    var datasets;

    // Initial fetch and index creation
    fetch('datasets.json').then(function(response) {
        return response.json();
    }).then(function(data) {
        datasets = data;
        idx = lunr(function() {
            this.ref('id');
            this.field('name');
            this.field('species');
            this.field('type');
            this.field('state');
            this.field('area');
            this.field('keywords');

            datasets.forEach(function(doc) {
                // Prepare document for indexing
                doc.area = doc.area.join(" "); // Convert area array to string
                this.add(doc);
            }, this);
        });
    });

    // Enhanced search function to include filters
    function search() {
        var userInput = document.getElementById('search-input').value;
        // Build the query string with filters
        var speciesMouse = document.getElementById('species-mouse').checked ? '+species:Mouse' : '';
        var typeEphys = document.getElementById('type-ephys').checked ? '+type:Electrophysiology' : '';
        
        // Add a wildcard to the user's input for partial matches
        // This will look for matches that start with the user's input
        var query = userInput.split(' ').map(word => `${word}*`).join(' ');

        // Combine user input with filters, ensuring filters are only applied if present
        query = [query, speciesMouse, typeEphys].filter(Boolean).join(' ');

        var results = idx.search(query); // Execute the search with the constructed query
        var resultData = results.map(function(result) {
            return datasets.find(dataset => dataset.id === result.ref);
        });

        var resultsHTML = resultData.length > 0 ? resultData.map(function(dataset) {
            return `<li>
                        <a href="${dataset.link}" target="_blank">${dataset.name}</a>
                        <p class="description">${dataset.description.slice(0, 100)}...</p>
                        <p class="metadata">Species: ${dataset.species} | Type: ${dataset.type}</p>
                    </li>`;
        }).join('') : '<p class="no-results">No results found.</p>';

        document.getElementById('results').innerHTML = `<ul>${resultsHTML}</ul>`;
    }
    </script>

</body>
</html>